# ---------------------------------------------------------------------------------------------------------------------- #
# Debug sudo command
# NOTE! This task MUST BE BEFORE "Set a hostname" task.

- name: template hosts
  template:
    src: hosts.j2
    dest: /etc/hosts

# ---------------------------------------------------------------------------------------------------------------------- #
# Hostname

- name: Set a hostname
  ansible.builtin.hostname:
    name: "{{ inventory_hostname }}"

# ---------------------------------------------------------------------------------------------------------------------- #
# Lecturers users

- name: Create user juri
  ansible.builtin.user:
    name: juri
    comment: Juri Hudolejev

- name: Create user roman
  ansible.builtin.user:
    name: roman
    comment: Roman Kuchin

#- name: Set authorized key for juri
#  ansible.posix.authorized_key:
#    user: juri
#    state: present
#    key: https://github.com/hudolejev.keys

#- name: Set authorized key for roman
#  ansible.posix.authorized_key:
#    user: roman
#    state: present
#    key: https://github.com/romankuchin.keys

# ---------------------------------------------------------------------------------------------------------------------- #
# Backup

- name: Install duplicity
  apt:
    name: 
      - duplicity

- name: Create backup user
  user:
    name: "{{ backup_user }}"
    comment: Backup User
    home: "{{ backup_user_home }}"
    move_home: true
    generate_ssh_key: true
    ssh_key_file: "{{ backup_user_home }}/.ssh/id_rsa"
    ssh_key_type: rsa
    system: true
  notify:
    - Change backup directory permissions

- name: Template known_hosts for backup
  template:
    src: known_hosts.backup.j2
    dest: "{{ backup_user_home }}/.ssh/known_hosts"
    owner: backup
    group: backup
    mode: '0600'
  no_log: true

# ---------------------------------------------------------------------------------------------------------------------- #
# APT updates

- name: Update APT cache
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 86400

- name: Update CA certificates
  ansible.builtin.apt:
    name: ca-certificates>=20211000*

# ---------------------------------------------------------------------------------------------------------------------- #
# .bash_aliases

- name: Add .bash_aliases to /home/ubuntu
  ansible.builtin.copy:
    src: ./roles/init/files/bash_aliases
    dest: /home/ubuntu/.bash_aliases
    owner: ubuntu
    group: ubuntu

# ---------------------------------------------------------------------------------------------------------------------- #
# DNS settings

- name: Template resolv.conf
  ansible.builtin.template:
    src: resolv.conf.j2
    dest: /etc/resolv.conf
  notify:
    - Restart systemd-resolved

# ---------------------------------------------------------------------------------------------------------------------- #
# Rsyslog configuration

- name: Copy telegraf-output.conf
  copy:
    src: telegraf-output.conf 
    dest: /etc/rsyslog.d/telegraf-output.conf
  notify:
    - Restart Rsyslog

# ---------------------------------------------------------------------------------------------------------------------- #
# Prometheus exporter

- name: Install prometheus-node-exporter
  ansible.builtin.apt:
    name: prometheus-node-exporter

# ---------------------------------------------------------------------------------------------------------------------- #
# Service

- name: Service prometheus-node-exporter
  ansible.builtin.service:
    name: prometheus-node-exporter
    state: started
    enabled: true
# ---------------------------------------------------------------------------------------------------------------------- #

#- debug: msg="trigger Change backup directory permissions"
#  notify: Change backup directory permissions
#  changed_when: true 
